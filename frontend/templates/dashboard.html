{% extends 'base.html' %}

{% block title %}Dashboard - SC Lead Generation{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_styles %}
<style>
.activity-log {
    max-height: 400px;
    overflow-y: auto;
}
.activity-log::-webkit-scrollbar {
    width: 6px;
}
.activity-log::-webkit-scrollbar-thumb {
    background-color: #bdc3c7;
    border-radius: 3px;
}
.top-leads-container {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: hidden;
}
.top-leads-container::-webkit-scrollbar {
    width: 8px;
}
.top-leads-container::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}
.top-leads-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}
.persona-badge {
    display: inline-block;
    padding: 6px 14px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px;
    font-size: 12px;
    margin: 4px;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}
.persona-detail {
    font-size: 11px;
    color: #64748b;
    margin-top: 4px;
}
.scraping-progress {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px solid #0ea5e9;
    border-radius: 12px;
}
.scraping-progress.active {
    display: block;
}
/* Non-blocking completion notification */
.completion-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 20px 30px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
    z-index: 9999;
    animation: slideInRight 0.5s ease-out;
    min-width: 350px;
}
.completion-toast-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.completion-toast-body {
    font-size: 14px;
    margin-bottom: 15px;
    opacity: 0.95;
}
.completion-toast-actions {
    display: flex;
    gap: 10px;
}
.completion-toast-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    transition: all 0.2s;
}
.completion-toast-btn-primary {
    background: white;
    color: #059669;
}
.completion-toast-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255,255,255,0.3);
}
.completion-toast-btn-secondary {
    background: rgba(255,255,255,0.2);
    color: white;
}
.completion-toast-btn-secondary:hover {
    background: rgba(255,255,255,0.3);
}
@keyframes slideInRight {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}
.ai-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
}
</style>
{% endblock %}

{% block content %}
<!-- Quick Actions Bar -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex flex-wrap gap-3">
        <button onclick="generateMessagesForTopLeads()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md flex items-center">
            <i data-feather="message-square" class="w-4 h-4 mr-2"></i>
            Generate Messages for Top Leads
        </button>
        <button onclick="window.location.href='/leads'" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center">
            <i data-feather="users" class="w-4 h-4 mr-2"></i>
            View All Leads
        </button>
        <button onclick="window.location.href='/messages'" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md flex items-center">
            <i data-feather="mail" class="w-4 h-4 mr-2"></i>
            View Messages
        </button>
    </div>
</div>

<!-- Dashboard Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Total Leads Scraped</p>
                <h3 class="text-2xl font-bold mt-1" id="total-leads">0</h3>
                <p class="text-green-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-up" class="w-3 h-3 mr-1"></i> <span id="total-leads-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
                <i data-feather="user-plus" class="w-5 h-5 text-blue-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Qualified Leads</p>
                <h3 class="text-2xl font-bold mt-1" id="qualified-leads">0</h3>
                <p class="text-green-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-up" class="w-3 h-3 mr-1"></i> <span id="qualified-leads-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
                <i data-feather="check-circle" class="w-5 h-5 text-green-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Messages Sent</p>
                <h3 class="text-2xl font-bold mt-1" id="messages-sent">0</h3>
                <p class="text-yellow-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-down" class="w-3 h-3 mr-1"></i> <span id="messages-sent-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
                <i data-feather="send" class="w-5 h-5 text-yellow-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Response Rate</p>
                <h3 class="text-2xl font-bold mt-1" id="response-rate">0%</h3>
                <p class="text-green-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-up" class="w-3 h-3 mr-1"></i> <span id="response-rate-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
                <i data-feather="message-circle" class="w-5 h-5 text-purple-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Smart Scraper Panel -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="lg:col-span-1 bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800">🤖 Smart LinkedIn Scraper</h2>
            <span class="ai-badge">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
                </svg>
                AI-POWERED
            </span>
        </div>
        
        <!-- AI-Generated Personas Display -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                AI-Detected Target Profiles:
            </label>
            <div id="loaded-personas" class="min-h-[80px] p-4 bg-gradient-to-br from-gray-50 to-blue-50 rounded-lg border-2 border-blue-100">
                <p class="text-sm text-gray-500 text-center">Loading personas...</p>
            </div>
            <div id="persona-details" class="mt-2 text-xs text-gray-600">
                <!-- Dynamic persona details will appear here -->
            </div>
        </div>
        
        <!-- Pages Selector -->
        <div class="mb-4">
            <label for="max-pages" class="block text-sm font-medium text-gray-700 mb-2">Pages to Scrape</label>
            <select id="max-pages" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="1">1 page (~10 leads)</option>
                <option value="3" selected>3 pages (~30 leads)</option>
                <option value="5">5 pages (~50 leads)</option>
                <option value="10">10 pages (~100 leads)</option>
            </select>
        </div>
        
        <!-- Smart Scraping Button -->
        <button id="start-scrape-btn" onclick="startSmartScraping()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-4 py-3 rounded-lg flex items-center justify-center font-semibold shadow-lg transition">
            <i data-feather="zap" class="w-5 h-5 mr-2"></i>
            Start AI Smart Scraping
        </button>
                
        <!-- Progress Indicator -->
        <div id="scraping-progress" class="scraping-progress">
            <div class="flex items-center mb-2">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                <span class="text-sm font-medium text-blue-800">AI is scraping...</span>
            </div>
            <p class="text-xs text-blue-700 font-medium" id="scraping-status">Initializing...</p>
        </div>
        
        <div class="mt-4 p-3 bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg">
            <p class="text-sm text-purple-900 font-medium flex items-center">
                <i data-feather="cpu" class="w-4 h-4 inline mr-2"></i>
                100% Automated Targeting
            </p>
            <p class="text-xs text-purple-700 mt-1">
                AI analyzes your uploaded document and automatically finds perfect-match prospects on LinkedIn!
            </p>
        </div>
    </div>
    
    <!-- Activity Feed and Top Leads -->
    <div class="lg:col-span-2 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">Live Activity Feed</h2>
            </div>
            <div class="activity-log p-6">
                <div class="space-y-4" id="activity-feed">
                    <p class="text-gray-500 text-center py-4">Loading activity...</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-800">Top Qualified Leads</h2>
                    <a href="/leads?min_score=70" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                        View All →
                    </a>
                </div>
            </div>
            <div class="top-leads-container p-4" id="top-leads-container">
                <p class="text-gray-500 text-center py-4">Loading leads...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/dashboard.js"></script>
<script>
    let loadedPersonas = [];
    let scrapingInterval = null;
    let personaContext = null;  // Store full persona context
    
    /**
     * Show non-blocking completion notification
     */
    function showCompletionNotification(leadsCount) {
        const toast = document.createElement('div');
        toast.className = 'completion-toast';
        toast.innerHTML = `
            <div class="completion-toast-title">
                <span>🎉</span>
                <span>Scraping Complete!</span>
            </div>
            <div class="completion-toast-body">
                Successfully scraped ${leadsCount} AI-matched leads from LinkedIn
            </div>
            <div class="completion-toast-actions">
                <button class="completion-toast-btn completion-toast-btn-primary" onclick="window.location.href='/leads'">
                    View Leads
                </button>
                <button class="completion-toast-btn completion-toast-btn-secondary" onclick="this.closest('.completion-toast').remove()">
                    Dismiss
                </button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Auto-dismiss after 10 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'slideOutRight 0.5s ease-in';
                setTimeout(() => toast.remove(), 500);
            }
        }, 10000);
    }
    
    /**
     * Load personas on page load - ENHANCED VERSION
     */
    async function loadPersonas() {
        try {
            const response = await fetch('/api/personas');
            const data = await response.json();
            
            if (data.success && data.personas && data.personas.length > 0) {
                loadedPersonas = data.personas;
                personaContext = data.persona_context || null;  // Get full context if available
                
                const container = document.getElementById('loaded-personas');
                const detailsContainer = document.getElementById('persona-details');
                
                // Show persona badges
                container.innerHTML = data.personas.map(p => 
                    `<span class="persona-badge">${p.name}</span>`
                ).join('');
                
                // Show smart targeting info
                if (personaContext && personaContext.search_queries) {
                    const topQueries = personaContext.search_queries.slice(0, 3);
                    detailsContainer.innerHTML = `
                        <div class="persona-detail">
                            <strong>🎯 AI Search Strategy:</strong> ${topQueries.join(', ')}
                        </div>
                    `;
                } else {
                    // Fallback: show job titles
                    const allTitles = data.personas
                        .map(p => p.job_titles)
                        .flat()
                        .filter(t => t)
                        .slice(0, 5);
                    
                    if (allTitles.length > 0) {
                        detailsContainer.innerHTML = `
                            <div class="persona-detail">
                                <strong>🔍 Targeting:</strong> ${allTitles.join(', ')}
                            </div>
                        `;
                    }
                }
                
            } else {
                document.getElementById('loaded-personas').innerHTML = 
                    '<p class="text-sm text-red-600">⚠️ No personas found! <a href="/" class="underline font-semibold">Upload a target document first</a>.</p>';
            }
        } catch (error) {
            console.error('Error loading personas:', error);
        }
    }
    
    /**
     * Start Smart Scraping - 100% AUTOMATED VERSION
     */
    async function startSmartScraping() {
        if (loadedPersonas.length === 0) {
            alert('⚠️ No target personas found!\n\nPlease upload a target document first in Settings.');
            window.location.href = '/';
            return;
        }
        
        const maxPages = document.getElementById('max-pages').value;
        
        // Build confirmation message
        const personaNames = loadedPersonas.map(p => p.name).join(', ');
        const estimatedLeads = maxPages * 10;
        
        const confirmed = confirm(
            `🤖 AI-Powered Smart Scraping Ready!\n\n` +
            `📊 AI-Detected Personas: ${personaNames}\n` +
            `📄 Pages: ${maxPages} (~${estimatedLeads} leads)\n` +
            `🎯 Targeting: Automatically optimized by AI\n\n` +
            `The system will:\n` +
            `✓ Login to LinkedIn\n` +
            `✓ Use AI-generated search queries\n` +
            `✓ Find profiles matching your personas\n` +
            `✓ Auto-score leads using AI\n` +
            `✓ Save to database\n\n` +
            `Continue?`
        );
        
        if (!confirmed) return;
        
        // Show progress
        const progressDiv = document.getElementById('scraping-progress');
        const statusText = document.getElementById('scraping-status');
        const startBtn = document.getElementById('start-scrape-btn');
        
        progressDiv.classList.add('active');
        startBtn.disabled = true;
        startBtn.innerHTML = '<i data-feather="loader" class="w-5 h-5 mr-2 animate-spin"></i> AI Scraping...';
        feather.replace();
        
        try {
            // ✅ Start scraping - NO KEYWORDS NEEDED, backend will auto-generate
            const response = await fetch('/api/bot/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    max_pages: parseInt(maxPages),
                    use_ai_targeting: true  // ✅ Signal to use AI-generated keywords
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                statusText.textContent = 'AI is analyzing and scraping perfect-match prospects...';
                
                // ✅ Poll bot status to detect ACTUAL completion
                scrapingInterval = setInterval(async () => {
                    loadActivityFeed();
                    loadStats();
                    
                    try {
                        const statusRes = await fetch('/api/bot/status');
                        const statusData = await statusRes.json();
                        
                        if (statusData.success && statusData.status) {
                            // Update status text in real-time
                            statusText.textContent = statusData.status.current_activity || 'AI is finding matches...';
                            
                            // ✅ Check if bot actually finished
                            if (!statusData.status.running) {
                                console.log('✅ Bot completed! Leads scraped:', statusData.status.leads_scraped);
                                
                                clearInterval(scrapingInterval);
                                scrapingInterval = null;
                                
                                // Hide progress UI
                                progressDiv.classList.remove('active');
                                startBtn.disabled = false;
                                startBtn.innerHTML = '<i data-feather="zap" class="w-5 h-5 mr-2"></i> Start AI Smart Scraping';
                                feather.replace();
                                
                                // ✅ Show NON-BLOCKING notification
                                showCompletionNotification(statusData.status.leads_scraped || 0);
                            }
                        }
                    } catch (error) {
                        console.error('Error checking bot status:', error);
                    }
                }, 5000);  // Check every 5 seconds
                
            } else {
                throw new Error(data.message || 'Failed to start scraper');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('❌ Error starting scraper: ' + error.message);
            
            progressDiv.classList.remove('active');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i data-feather="zap" class="w-5 h-5 mr-2"></i> Start AI Smart Scraping';
            feather.replace();
            
            if (scrapingInterval) {
                clearInterval(scrapingInterval);
            }
        }
    }
    
    /**
     * Generate messages for top leads - USES AI PERSONA CONTEXT
     */
    async function generateMessagesForTopLeads() {
        const confirmed = confirm('Generate AI-powered personalized messages for the top 20 qualified leads?');
        if (!confirmed) return;
        
        try {
            const response = await fetch('/api/leads/top?limit=20&min_score=70');
            const data = await response.json();
            
            if (!data.success || data.leads.length === 0) {
                alert('No qualified leads found. Scrape some leads first!');
                return;
            }
            
            const leadIds = data.leads.map(lead => lead.id);
            
            const genResponse = await fetch('/api/messages/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    lead_ids: leadIds,
                    use_persona_context: true  // ✅ Use enhanced persona context
                })
            });
            
            const genData = await genResponse.json();
            
            if (genData.success) {
                alert(`✅ Generated ${genData.count || data.leads.length * 3} personalized AI messages!`);
                setTimeout(() => window.location.href = '/messages', 2000);
            } else {
                alert('❌ ' + genData.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error generating messages');
        }
    }
    
    /**
     * Load activity feed
     */
    function loadActivityFeed() {
        fetch('/api/activity-logs?limit=10')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.logs) {
                    const container = document.getElementById('activity-feed');
                    
                    if (data.logs.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity</p>';
                        return;
                    }
                    
                    container.innerHTML = data.logs.map(log => `
                        <div class="flex items-start space-x-3 pb-3 border-b border-gray-100">
                            <div class="flex-shrink-0">
                                <i data-feather="activity" class="w-4 h-4 text-gray-400"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800">${log.description}</p>
                                <p class="text-xs text-gray-500 mt-1">${new Date(log.created_at).toLocaleString()}</p>
                            </div>
                        </div>
                    `).join('');
                    
                    feather.replace();
                }
            })
            .catch(error => console.error('Error loading activity:', error));
    }
    
    /**
     * Load stats
     */
    function loadStats() {
        fetch('/api/analytics/dashboard')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.stats) {
                    document.getElementById('total-leads').textContent = data.stats.total_leads || 0;
                    document.getElementById('qualified-leads').textContent = data.stats.qualified_leads || 0;
                    document.getElementById('messages-sent').textContent = data.stats.messages_sent || 0;
                    document.getElementById('response-rate').textContent = (data.stats.reply_rate || 0) + '%';
                }
            })
            .catch(error => console.error('Error loading stats:', error));
    }
    
    /**
     * Load top leads
     */
    function loadTopLeads() {
        fetch('/api/leads/top?limit=5&min_score=70')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.leads) {
                    const container = document.getElementById('top-leads-container');
                    
                    if (data.leads.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4">No qualified leads yet</p>';
                        return;
                    }
                    
                    container.innerHTML = data.leads.map(lead => `
                        <div class="p-3 border border-gray-200 rounded-md mb-3 hover:bg-gray-50 cursor-pointer" onclick="window.location.href='/leads'">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800">${lead.name}</h3>
                                    <p class="text-sm text-gray-600">${lead.title || 'N/A'}</p>
                                    <p class="text-xs text-gray-500">${lead.company || 'N/A'}</p>
                                </div>
                                <div class="text-right">
                                    <span class="inline-block px-2 py-1 text-xs font-semibold rounded ${
                                        lead.ai_score >= 80 ? 'bg-green-100 text-green-800' :
                                        lead.ai_score >= 60 ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">${lead.ai_score}/100</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            })
            .catch(error => console.error('Error loading top leads:', error));
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        loadPersonas();
        loadStats();
        loadActivityFeed();
        loadTopLeads();
        
        // Auto-refresh every 10 seconds
        setInterval(() => {
            loadStats();
            loadTopLeads();
            if (!document.getElementById('scraping-progress').classList.contains('active')) {
                loadActivityFeed();
            }
        }, 10000);
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (scrapingInterval) {
            clearInterval(scrapingInterval);
        }
    });
</script>
{% endblock %}
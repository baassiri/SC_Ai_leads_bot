{% extends 'base.html' %}

{% block title %}Dashboard - SC Lead Generation{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_styles %}
<style>
.activity-log {
    max-height: 400px;
    overflow-y: auto;
}
.activity-log::-webkit-scrollbar {
    width: 6px;
}
.activity-log::-webkit-scrollbar-thumb {
    background-color: #bdc3c7;
    border-radius: 3px;
}
.log-info {
    color: #3498DB;
}
.log-success {
    color: #27AE60;
}
.log-error {
    color: #E74C3C;
}
.top-leads-container {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: hidden;
}
.top-leads-container::-webkit-scrollbar {
    width: 8px;
}
.top-leads-container::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}
.top-leads-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}
.top-leads-container::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>
{% endblock %}

{% block content %}
<!-- Quick Actions Bar -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex flex-wrap gap-3">
        <button onclick="generateMessagesForTopLeads()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md flex items-center">
            <i data-feather="message-square" class="w-4 h-4 mr-2"></i>
            Generate Messages for Top Leads
        </button>
        <button onclick="window.location.href='/leads'" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center">
            <i data-feather="users" class="w-4 h-4 mr-2"></i>
            View All Leads
        </button>
        <button onclick="window.location.href='/messages'" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md flex items-center">
            <i data-feather="mail" class="w-4 h-4 mr-2"></i>
            View Messages
        </button>
    </div>
</div>

<!-- Dashboard Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Total Leads Scraped</p>
                <h3 class="text-2xl font-bold mt-1" id="total-leads">0</h3>
                <p class="text-green-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-up" class="w-3 h-3 mr-1"></i> <span id="total-leads-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
                <i data-feather="user-plus" class="w-5 h-5 text-blue-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Qualified Leads</p>
                <h3 class="text-2xl font-bold mt-1" id="qualified-leads">0</h3>
                <p class="text-green-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-up" class="w-3 h-3 mr-1"></i> <span id="qualified-leads-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
                <i data-feather="check-circle" class="w-5 h-5 text-green-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Messages Sent</p>
                <h3 class="text-2xl font-bold mt-1" id="messages-sent">0</h3>
                <p class="text-yellow-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-down" class="w-3 h-3 mr-1"></i> <span id="messages-sent-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
                <i data-feather="send" class="w-5 h-5 text-yellow-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Response Rate</p>
                <h3 class="text-2xl font-bold mt-1" id="response-rate">0%</h3>
                <p class="text-green-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-up" class="w-3 h-3 mr-1"></i> <span id="response-rate-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
                <i data-feather="message-circle" class="w-5 h-5 text-purple-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Scraper Control Panel - NEW SECTION -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="lg:col-span-1 bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ¤– LinkedIn Scraper</h2>
        
        <div class="mb-4">
            <label for="search-keywords" class="block text-sm font-medium text-gray-700 mb-2">Search Keywords</label>
            <input 
                type="text" 
                id="search-keywords" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                placeholder="e.g., plastic surgeon dermatologist"
                value="plastic surgeon dermatologist"
            />
            <small class="text-gray-500">Enter job titles, industries, or keywords</small>
        </div>
        
        <div class="mb-4">
            <label for="max-pages" class="block text-sm font-medium text-gray-700 mb-2">Pages to Scrape</label>
            <select id="max-pages" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="1">1 page (~10 leads)</option>
                <option value="3" selected>3 pages (~30 leads)</option>
                <option value="5">5 pages (~50 leads)</option>
                <option value="10">10 pages (~100 leads)</option>
            </select>
        </div>
        
        <button onclick="startRealScraping()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center justify-center">
            <i data-feather="play" class="w-4 h-4 mr-2"></i>
            Start Scraping REAL Profiles
        </button>
        
        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
            <p class="text-sm text-blue-800">
                <i data-feather="info" class="w-4 h-4 inline mr-1"></i>
                This will scrape REAL LinkedIn profiles and AI will score them automatically.
            </p>
        </div>
    </div>
    
    <!-- Two Column Layout -->
    <div class="lg:col-span-2 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Live Activity Feed -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">Live Activity Feed</h2>
            </div>
            <div class="activity-log p-6">
                <div class="space-y-4" id="activity-feed">
                    <p class="text-gray-500 text-center py-4">Loading activity...</p>
                </div>
            </div>
        </div>
        
        <!-- Top Qualified Leads -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-800">Top Qualified Leads</h2>
                    <a href="/leads?min_score=70" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                        View All â†’
                    </a>
                </div>
            </div>
            <div class="top-leads-container p-4" id="top-leads-container">
                <p class="text-gray-500 text-center py-4">Loading leads...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/dashboard.js"></script>
<script>
    /**
     * Start REAL LinkedIn scraping
     */
    async function startRealScraping() {
        const keywords = document.getElementById('search-keywords').value;
        const maxPages = document.getElementById('max-pages').value;
        
        if (!keywords.trim()) {
            alert('Please enter search keywords!');
            return;
        }
        
        const confirmed = confirm(`Start scraping REAL LinkedIn profiles for:\n"${keywords}"\n\nThis will:\n1. Search LinkedIn for real people\n2. Scrape ${maxPages} page(s) of results\n3. AI will score each lead\n\nContinue?`);
        
        if (!confirmed) return;
        
        try {
            const response = await fetch('/api/scrape/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    keywords: keywords,
                    max_pages: parseInt(maxPages)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Scraping started! Watch the activity feed for progress.', 'success');
                
                // Refresh activity feed every 5 seconds
                const refreshInterval = setInterval(() => {
                    loadActivityFeed();
                }, 5000);
                
                // Stop refreshing after 2 minutes
                setTimeout(() => {
                    clearInterval(refreshInterval);
                    // Navigate to leads page
                    window.location.href = '/leads';
                }, 120000);
            } else {
                showNotification(data.message, 'error');
            }
        } catch (error) {
            showNotification('Error starting scraper', 'error');
            console.error(error);
        }
    }
    
    /**
     * Generate messages for top 20 leads
     */
    async function generateMessagesForTopLeads() {
        const confirmed = confirm('Generate AI messages for the top 20 qualified leads?');
        if (!confirmed) return;
        
        try {
            // Get top 20 leads
            const response = await fetch('/api/leads/top?limit=20&min_score=70');
            const data = await response.json();
            
            if (!data.success || data.leads.length === 0) {
                showNotification('No qualified leads found. Scrape some leads first!', 'warning');
                return;
            }
            
            const leadIds = data.leads.map(lead => lead.id);
            
            // Generate messages
            const genResponse = await fetch('/api/messages/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lead_ids: leadIds })
            });
            
            const genData = await genResponse.json();
            
            if (genData.success) {
                showNotification(`Generated messages for ${data.leads.length} leads!`, 'success');
                setTimeout(() => {
                    window.location.href = '/messages';
                }, 2000);
            } else {
                showNotification(genData.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error generating messages', 'error');
        }
    }
    
    /**
     * Show notification
     */
    function showNotification(message, type) {
        // Simple alert for now - you can enhance this
        alert(message);
    }
    
    /**
     * Load activity feed
     */
    function loadActivityFeed() {
        fetch('/api/activity-logs?limit=10')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.logs) {
                    const container = document.getElementById('activity-feed');
                    
                    if (data.logs.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity</p>';
                        return;
                    }
                    
                    container.innerHTML = data.logs.map(log => `
                        <div class="flex items-start space-x-3 pb-3 border-b border-gray-100">
                            <div class="flex-shrink-0">
                                <i data-feather="activity" class="w-4 h-4 text-gray-400"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800">${log.description}</p>
                                <p class="text-xs text-gray-500 mt-1">${new Date(log.created_at).toLocaleString()}</p>
                            </div>
                        </div>
                    `).join('');
                    
                    feather.replace();
                }
            })
            .catch(error => console.error('Error loading activity:', error));
    }
    
    /**
     * Load stats
     */
    function loadStats() {
        fetch('/api/analytics/dashboard')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.stats) {
                    document.getElementById('total-leads').textContent = data.stats.total_leads || 0;
                    document.getElementById('qualified-leads').textContent = data.stats.qualified_leads || 0;
                    document.getElementById('messages-sent').textContent = data.stats.messages_sent || 0;
                    document.getElementById('response-rate').textContent = (data.stats.reply_rate || 0) + '%';
                }
            })
            .catch(error => console.error('Error loading stats:', error));
    }
    
    /**
     * Load top leads
     */
    function loadTopLeads() {
        fetch('/api/leads/top?limit=5&min_score=70')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.leads) {
                    const container = document.getElementById('top-leads-container');
                    
                    if (data.leads.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4">No qualified leads yet</p>';
                        return;
                    }
                    
                    container.innerHTML = data.leads.map(lead => `
                        <div class="p-3 border border-gray-200 rounded-md mb-3 hover:bg-gray-50">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800">${lead.name}</h3>
                                    <p class="text-sm text-gray-600">${lead.title || 'N/A'}</p>
                                    <p class="text-xs text-gray-500">${lead.company || 'N/A'}</p>
                                </div>
                                <div class="text-right">
                                    <span class="inline-block px-2 py-1 text-xs font-semibold rounded ${
                                        lead.ai_score >= 80 ? 'bg-green-100 text-green-800' :
                                        lead.ai_score >= 60 ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">${lead.ai_score}/100</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            })
            .catch(error => console.error('Error loading top leads:', error));
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        loadStats();
        loadActivityFeed();
        loadTopLeads();
        
        // Refresh every 10 seconds
        setInterval(() => {
            loadStats();
            loadActivityFeed();
            loadTopLeads();
        }, 10000);
    });
</script>
{% endblock %}
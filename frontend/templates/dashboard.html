{% extends 'base.html' %}

{% block title %}Dashboard - SC Lead Generation{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_styles %}
<style>
.activity-log {
    max-height: 400px;
    overflow-y: auto;
}
.activity-log::-webkit-scrollbar {
    width: 6px;
}
.activity-log::-webkit-scrollbar-thumb {
    background-color: #bdc3c7;
    border-radius: 3px;
}
.top-leads-container {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: hidden;
}
.top-leads-container::-webkit-scrollbar {
    width: 8px;
}
.top-leads-container::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}
.top-leads-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}
.persona-badge {
    display: inline-block;
    padding: 4px 12px;
    background: #e0f2fe;
    color: #0369a1;
    border-radius: 16px;
    font-size: 12px;
    margin: 4px;
    font-weight: 500;
}
.scraping-progress {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    background: #f0f9ff;
    border: 1px solid #0ea5e9;
    border-radius: 0.5rem;
}
.scraping-progress.active {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<!-- Quick Actions Bar -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex flex-wrap gap-3">
        <button onclick="generateMessagesForTopLeads()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md flex items-center">
            <i data-feather="message-square" class="w-4 h-4 mr-2"></i>
            Generate Messages for Top Leads
        </button>
        <button onclick="window.location.href='/leads'" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center">
            <i data-feather="users" class="w-4 h-4 mr-2"></i>
            View All Leads
        </button>
        <button onclick="window.location.href='/messages'" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md flex items-center">
            <i data-feather="mail" class="w-4 h-4 mr-2"></i>
            View Messages
        </button>
    </div>
</div>

<!-- Dashboard Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Total Leads Scraped</p>
                <h3 class="text-2xl font-bold mt-1" id="total-leads">0</h3>
                <p class="text-green-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-up" class="w-3 h-3 mr-1"></i> <span id="total-leads-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
                <i data-feather="user-plus" class="w-5 h-5 text-blue-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Qualified Leads</p>
                <h3 class="text-2xl font-bold mt-1" id="qualified-leads">0</h3>
                <p class="text-green-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-up" class="w-3 h-3 mr-1"></i> <span id="qualified-leads-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
                <i data-feather="check-circle" class="w-5 h-5 text-green-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Messages Sent</p>
                <h3 class="text-2xl font-bold mt-1" id="messages-sent">0</h3>
                <p class="text-yellow-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-down" class="w-3 h-3 mr-1"></i> <span id="messages-sent-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
                <i data-feather="send" class="w-5 h-5 text-yellow-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Response Rate</p>
                <h3 class="text-2xl font-bold mt-1" id="response-rate">0%</h3>
                <p class="text-green-600 text-sm mt-1 flex items-center">
                    <i data-feather="arrow-up" class="w-3 h-3 mr-1"></i> <span id="response-rate-change">0%</span> from last week
                </p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
                <i data-feather="message-circle" class="w-5 h-5 text-purple-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Smart Scraper Panel -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="lg:col-span-1 bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">ü§ñ Smart LinkedIn Scraper</h2>
        
        <!-- Show Loaded Personas -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Target Profiles:</label>
            <div id="loaded-personas" class="min-h-[60px] p-3 bg-gray-50 rounded-md border border-gray-200">
                <p class="text-sm text-gray-500">Loading personas...</p>
            </div>
        </div>
        
        <!-- Pages Selector -->
        <div class="mb-4">
            <label for="max-pages" class="block text-sm font-medium text-gray-700 mb-2">Pages to Scrape</label>
            <select id="max-pages" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="1">1 page (~10 leads)</option>
                <option value="3" selected>3 pages (~30 leads)</option>
                <option value="5">5 pages (~50 leads)</option>
                <option value="10">10 pages (~100 leads)</option>
            </select>
        </div>
        
        <!-- Smart Scraping Button -->
        <button id="start-scrape-btn" onclick="startSmartScraping()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center justify-center">
            <i data-feather="zap" class="w-4 h-4 mr-2"></i>
            Start Smart Scraping
        </button>
        
        <!-- Progress Indicator -->
        <div id="scraping-progress" class="scraping-progress">
            <div class="flex items-center mb-2">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                <span class="text-sm font-medium text-blue-800">Scraping in progress...</span>
            </div>
            <p class="text-xs text-blue-600" id="scraping-status">Initializing...</p>
        </div>
        
        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
            <p class="text-sm text-blue-800">
                <i data-feather="info" class="w-4 h-4 inline mr-1"></i>
                AI automatically uses job titles from your personas to find the best leads!
            </p>
        </div>
    </div>
    
    <!-- Activity Feed and Top Leads -->
    <div class="lg:col-span-2 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">Live Activity Feed</h2>
            </div>
            <div class="activity-log p-6">
                <div class="space-y-4" id="activity-feed">
                    <p class="text-gray-500 text-center py-4">Loading activity...</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-800">Top Qualified Leads</h2>
                    <a href="/leads?min_score=70" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                        View All ‚Üí
                    </a>
                </div>
            </div>
            <div class="top-leads-container p-4" id="top-leads-container">
                <p class="text-gray-500 text-center py-4">Loading leads...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/dashboard.js"></script>
<script>
    let loadedPersonas = [];
    let scrapingInterval = null;
    
    /**
     * Load personas on page load
     */
    async function loadPersonas() {
        try {
            const response = await fetch('/api/personas');
            const data = await response.json();
            
            if (data.success && data.personas && data.personas.length > 0) {
                loadedPersonas = data.personas;
                
                const container = document.getElementById('loaded-personas');
                container.innerHTML = data.personas.map(p => 
                    `<span class="persona-badge">${p.name}</span>`
                ).join('');
            } else {
                document.getElementById('loaded-personas').innerHTML = 
                    '<p class="text-sm text-red-600">‚ö†Ô∏è No personas found! <a href="/" class="underline">Upload a document first</a>.</p>';
            }
        } catch (error) {
            console.error('Error loading personas:', error);
        }
    }
    
    /**
     * Extract smart keywords from personas
     * IMPROVED: Better keyword extraction for Sales Nav
     */
    function extractSmartKeywords(personas) {
        // Combine job titles from all personas (best for Sales Nav)
        const titles = personas
            .map(p => p.job_titles)
            .flat()
            .filter(t => t && t.trim())
            .slice(0, 5);  // Top 5 titles
        
        if (titles.length > 0) {
            return titles.join(' OR ');  // Sales Nav likes OR syntax
        }
        
        // Fallback: use persona names
        return personas
            .map(p => p.name)
            .filter(n => n)
            .join(' ');
    }
    
    /**
     * Start Smart Scraping - Auto-uses ALL persona keywords
     */
    async function startSmartScraping() {
        if (loadedPersonas.length === 0) {
            alert('‚ö†Ô∏è No personas found!\n\nPlease upload a target document first in Settings.');
            window.location.href = '/';
            return;
        }
        
        const maxPages = document.getElementById('max-pages').value;
        
        // Build SMART keywords from personas (job titles work best)
        const smartKeywords = extractSmartKeywords(loadedPersonas);
        
        const confirmed = confirm(
            `ü§ñ Smart Scraping Ready!\n\n` +
            `Search Keywords: ${smartKeywords}\n\n` +
            `Targeting: ${loadedPersonas.map(p => p.name).join(', ')}\n` +
            `Pages: ${maxPages} (~${maxPages * 10} leads)\n\n` +
            `This will:\n` +
            `1. Login to LinkedIn\n` +
            `2. Try Sales Navigator first (if available)\n` +
            `3. Scrape REAL profiles matching your personas\n` +
            `4. Auto-score and save to database\n\n` +
            `Continue?`
        );
        
        if (!confirmed) return;
        
        // Show progress
        const progressDiv = document.getElementById('scraping-progress');
        const statusText = document.getElementById('scraping-status');
        const startBtn = document.getElementById('start-scrape-btn');
        
        progressDiv.classList.add('active');
        startBtn.disabled = true;
        startBtn.innerHTML = '<i data-feather="loader" class="w-4 h-4 mr-2 animate-spin"></i> Scraping...';
        feather.replace();
        
        try {
            // Start scraping
            const response = await fetch('/api/bot/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    keywords: smartKeywords,
                    max_pages: parseInt(maxPages)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                statusText.textContent = 'Scraping started! Watch the Activity Feed for progress.';
                
                // Poll activity feed every 5 seconds
                scrapingInterval = setInterval(() => {
                    loadActivityFeed();
                    loadStats();
                }, 5000);
                
                // Auto-navigate to leads after 2 minutes
                setTimeout(() => {
                    if (scrapingInterval) {
                        clearInterval(scrapingInterval);
                    }
                    progressDiv.classList.remove('active');
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i data-feather="zap" class="w-4 h-4 mr-2"></i> Start Smart Scraping';
                    feather.replace();
                    
                    if (confirm('‚úÖ Scraping complete! View leads now?')) {
                        window.location.href = '/leads';
                    }
                }, 120000);
            } else {
                throw new Error(data.message || 'Failed to start scraper');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error starting scraper: ' + error.message);
            
            progressDiv.classList.remove('active');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i data-feather="zap" class="w-4 h-4 mr-2"></i> Start Smart Scraping';
            feather.replace();
            
            if (scrapingInterval) {
                clearInterval(scrapingInterval);
            }
        }
    }
    
    /**
     * Generate messages for top leads
     */
    async function generateMessagesForTopLeads() {
        const confirmed = confirm('Generate AI messages for the top 20 qualified leads?');
        if (!confirmed) return;
        
        try {
            const response = await fetch('/api/leads/top?limit=20&min_score=70');
            const data = await response.json();
            
            if (!data.success || data.leads.length === 0) {
                alert('No qualified leads found. Scrape some leads first!');
                return;
            }
            
            const leadIds = data.leads.map(lead => lead.id);
            
            const genResponse = await fetch('/api/messages/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lead_ids: leadIds })
            });
            
            const genData = await genResponse.json();
            
            if (genData.success) {
                alert(`‚úÖ Generated messages for ${data.leads.length} leads!`);
                setTimeout(() => window.location.href = '/messages', 2000);
            } else {
                alert('‚ùå ' + genData.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error generating messages');
        }
    }
    
    /**
     * Load activity feed
     */
    function loadActivityFeed() {
        fetch('/api/activity-logs?limit=10')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.logs) {
                    const container = document.getElementById('activity-feed');
                    
                    if (data.logs.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity</p>';
                        return;
                    }
                    
                    container.innerHTML = data.logs.map(log => `
                        <div class="flex items-start space-x-3 pb-3 border-b border-gray-100">
                            <div class="flex-shrink-0">
                                <i data-feather="activity" class="w-4 h-4 text-gray-400"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800">${log.description}</p>
                                <p class="text-xs text-gray-500 mt-1">${new Date(log.created_at).toLocaleString()}</p>
                            </div>
                        </div>
                    `).join('');
                    
                    feather.replace();
                }
            })
            .catch(error => console.error('Error loading activity:', error));
    }
    
    /**
     * Load stats
     */
    function loadStats() {
        fetch('/api/analytics/dashboard')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.stats) {
                    document.getElementById('total-leads').textContent = data.stats.total_leads || 0;
                    document.getElementById('qualified-leads').textContent = data.stats.qualified_leads || 0;
                    document.getElementById('messages-sent').textContent = data.stats.messages_sent || 0;
                    document.getElementById('response-rate').textContent = (data.stats.reply_rate || 0) + '%';
                }
            })
            .catch(error => console.error('Error loading stats:', error));
    }
    
    /**
     * Load top leads
     */
    function loadTopLeads() {
        fetch('/api/leads/top?limit=5&min_score=70')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.leads) {
                    const container = document.getElementById('top-leads-container');
                    
                    if (data.leads.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4">No qualified leads yet</p>';
                        return;
                    }
                    
                    container.innerHTML = data.leads.map(lead => `
                        <div class="p-3 border border-gray-200 rounded-md mb-3 hover:bg-gray-50 cursor-pointer" onclick="window.location.href='/leads'">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800">${lead.name}</h3>
                                    <p class="text-sm text-gray-600">${lead.title || 'N/A'}</p>
                                    <p class="text-xs text-gray-500">${lead.company || 'N/A'}</p>
                                </div>
                                <div class="text-right">
                                    <span class="inline-block px-2 py-1 text-xs font-semibold rounded ${
                                        lead.ai_score >= 80 ? 'bg-green-100 text-green-800' :
                                        lead.ai_score >= 60 ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">${lead.ai_score}/100</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            })
            .catch(error => console.error('Error loading top leads:', error));
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        loadPersonas();
        loadStats();
        loadActivityFeed();
        loadTopLeads();
        
        // Auto-refresh every 10 seconds
        setInterval(() => {
            loadStats();
            loadTopLeads();
            // Activity feed refreshes more often during scraping
            if (!document.getElementById('scraping-progress').classList.contains('active')) {
                loadActivityFeed();
            }
        }, 10000);
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (scrapingInterval) {
            clearInterval(scrapingInterval);
        }
    });
</script>
{% endblock %}
{% extends 'base.html' %}

{% block title %}Messages - Aesthetic LinkWizard{% endblock %}

{% block page_title %}Messages{% endblock %}

{% block extra_styles %}
<style>
.message-thread {
    max-height: 500px;
    overflow-y: auto;
}
.message-thread::-webkit-scrollbar {
    width: 6px;
}
.message-thread::-webkit-scrollbar-thumb {
    background-color: #bdc3c7;
    border-radius: 3px;
}
@keyframes slide-in {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
.animate-slide-in {
    animation: slide-in 0.3s ease-out;
}

/* âœ… NEW: Checkbox styles */
.message-checkbox {
    accent-color: #3b82f6;
    cursor: pointer;
}

#select-all-messages {
    accent-color: #3b82f6;
    cursor: pointer;
}

#select-all-messages:indeterminate {
    accent-color: #6b7280;
}

.message-card {
    transition: opacity 0.3s ease, transform 0.3s ease;
    position: relative;
}

.message-card.hiding {
    opacity: 0;
    transform: scale(0.95);
}

.btn:disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
}

.btn:not(:disabled):hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

#auto-approve-all-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
}
</style>
{% endblock %}

{% block content %}
<!-- Quick Stats Bar -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-gray-100 mr-3">
                <i data-feather="edit-3" class="w-5 h-5 text-gray-600"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600">Draft</p>
                <p class="text-2xl font-bold text-gray-800" id="stat-draft">0</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 mr-3">
                <i data-feather="check-circle" class="w-5 h-5 text-yellow-600"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600">Approved</p>
                <p class="text-2xl font-bold text-yellow-600" id="stat-approved">0</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 mr-3">
                <i data-feather="send" class="w-5 h-5 text-green-600"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600">Sent</p>
                <p class="text-2xl font-bold text-green-600" id="stat-sent">0</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 mr-3">
                <i data-feather="message-circle" class="w-5 h-5 text-blue-600"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600">Total</p>
                <p class="text-2xl font-bold text-blue-600" id="stat-total">0</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Bar -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex flex-wrap gap-3 items-center justify-between">
        <div class="flex flex-wrap gap-3 items-center">
            <!-- âœ… NEW: Select All Checkbox -->
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500; padding: 8px 12px; background: #f3f4f6; border-radius: 6px;">
                <input type="checkbox" id="select-all-messages" style="width: 18px; height: 18px;">
                <span>Select All</span>
            </label>
            
            <!-- Divider -->
            <div style="width: 1px; height: 30px; background: #e5e7eb;"></div>
            
            <!-- Filter Buttons -->
            <button data-filter="draft" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-md text-sm flex items-center transition ring-2 ring-blue-500">
                <i data-feather="edit" class="w-4 h-4 mr-2"></i>
                Draft Messages
            </button>
            <button data-filter="approved" class="bg-yellow-50 hover:bg-yellow-100 text-yellow-700 px-4 py-2 rounded-md text-sm flex items-center transition">
                <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                Approved Messages
            </button>
            <button data-filter="sent" class="bg-green-50 hover:bg-green-100 text-green-700 px-4 py-2 rounded-md text-sm flex items-center transition">
                <i data-feather="send" class="w-4 h-4 mr-2"></i>
                Sent Messages
            </button>
            
            <!-- Divider -->
            <div style="width: 1px; height: 30px; background: #e5e7eb;"></div>
            
            <!-- âœ… NEW: Bulk Actions -->
            <button id="bulk-approve-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm flex items-center transition" disabled>
                <i data-feather="check-square" class="w-4 h-4 mr-2"></i>
                Approve Selected
            </button>
            
            <button id="bulk-delete-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm flex items-center transition" disabled>
                <i data-feather="trash-2" class="w-4 h-4 mr-2"></i>
                Delete Selected
            </button>
            
            <!-- Divider -->
            <div style="width: 1px; height: 30px; background: #e5e7eb;"></div>
            
            <!-- âœ… NEW: Auto-Approve All Button -->
            <button id="auto-approve-all-btn" 
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
                           color: white;
                           border: none; 
                           padding: 10px 20px; 
                           font-weight: 600;
                           border-radius: 6px;
                           box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
                           cursor: pointer;
                           transition: all 0.2s;
                           display: flex;
                           align-items: center;
                           gap: 6px;">
                <i data-feather="zap" class="w-4 h-4"></i>
                âœ¨ Auto-Approve All
            </button>
            
            <button onclick="sendAllApprovedMessages()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm flex items-center transition">
                <i data-feather="send" class="w-4 h-4 mr-2"></i>
                Send All Approved
            </button>
        </div>
        
        <div class="flex gap-2">
            <select id="lead-filter" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:border-secondary">
                <option value="">All Leads</option>
            </select>
            <button onclick="loadMessages(currentFilter)" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-md transition" title="Refresh">
                <i data-feather="refresh-cw" class="w-5 h-5"></i>
            </button>
        </div>
    </div>
</div>

<!-- Messages Container -->
<div id="messages-container" class="space-y-6">
    <div class="bg-white rounded-lg shadow p-8 text-center">
        <i data-feather="loader" class="w-12 h-12 mx-auto animate-spin text-blue-500 mb-4"></i>
        <p class="text-gray-500">Loading messages...</p>
    </div>
</div>

<!-- Help Section -->
<div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex items-start">
        <i data-feather="info" class="w-5 h-5 text-blue-600 mr-3 mt-1"></i>
        <div>
            <h3 class="text-blue-900 font-semibold mb-1">A/B/C Testing Guide</h3>
            <ul class="text-sm text-blue-700 space-y-1">
                <li><strong>Variant A:</strong> Direct and value-focused message</li>
                <li><strong>Variant B:</strong> Curiosity-driven with questions</li>
                <li><strong>Variant C:</strong> Social proof and authority</li>
            </ul>
            <p class="text-sm text-blue-600 mt-2">ðŸ’¡ Tip: Use Auto-Approve All to automatically pick Variant A for each lead!</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/messages.js"></script>
<script src="/static/js/schedule.js"></script>
<script>
    // Update stats after loading messages
    function updateStats() {
        fetch('/api/messages/stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('stat-draft').textContent = data.stats.draft || 0;
                    document.getElementById('stat-approved').textContent = data.stats.approved || 0;
                    document.getElementById('stat-sent').textContent = data.stats.sent || 0;
                    document.getElementById('stat-total').textContent = data.stats.total || 0;
                }
            })
            .catch(error => console.error('Error loading stats:', error));
    }
    
    // Update stats every 10 seconds
    setInterval(updateStats, 10000);
    updateStats();
    
    // Replace feather icons after page load
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
    });
</script>
<script src="{{ url_for('static', filename='js/schedule-ui.js') }}"></script>
{% endblock %}